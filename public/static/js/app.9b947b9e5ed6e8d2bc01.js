webpackJsonp([1],{0:function(t,e){},1:function(t,e){},D0tr:function(t,e){},NHnr:function(t,e,o){"use strict";function s(t){o("iBKY")}function r(t){o("D0tr")}Object.defineProperty(e,"__esModule",{value:!0});var a=o("7+uW"),n={name:"app",methods:{logout:function(){var t=this;a.default.http.get("/auth/logout").then(function(e){"logout success!"===e.body?(localStorage.removeItem("userid"),localStorage.removeItem("current_room"),localStorage.removeItem("joined_rooms"),localStorage.removeItem("logs"),t.$router.replace("/")):console.log("logout failed!")})},isShow:function(){return null!==localStorage.getItem("userid")},showStats:function(){this.$router.replace("/stats")}}},l=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{attrs:{id:"app"}},[o("el-menu",{attrs:{mode:"horizontal","background-color":"#545c64","text-color":"#fff","active-text-color":"#ffd04b"}},[t.isShow()?o("el-menu-item",{attrs:{index:"1"},on:{click:t.showStats}},[t._v("Stats")]):t._e(),t._v(" "),o("el-menu-item",{attrs:{index:"2"},on:{click:t.logout}},[t._v("Log Out")])],1),t._v(" "),o("router-view")],1)},i=[],c={render:l,staticRenderFns:i},m=c,u=o("VU/8"),d=u(n,m,!1,null,null,null),f=d.exports,g=o("ORbq"),p=o("/ocq"),_=o("DmT9"),h=o.n(_),v={data:function(){return{socket:h()(),status:"",form:{username:"",password:""}}},methods:{onSubmit:function(){var t=this;a.default.http.post("/auth/login",{username:this.form.username,password:this.form.password}).then(function(e){"login success"===e.body?(t.status="login success",localStorage.setItem("userid",t.form.username),t.socket.emit("stats",{userid:t.form.username,action:"login",message:""}),t.socket.close(),t.$router.replace("/rooms")):t.status=e.body}).catch(function(e){t.status=e.message})}}},b=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("el-row",{staticStyle:{"margin-top":"7%"}},[o("el-col",{attrs:{span:8,offset:7}},[o("el-form",{ref:"form",attrs:{model:t.form,"label-width":"120px"}},[o("el-form-item",{attrs:{label:"username"}},[o("el-input",{model:{value:t.form.username,callback:function(e){t.$set(t.form,"username",e)},expression:"form.username"}})],1),t._v(" "),o("el-form-item",{attrs:{label:"password"}},[o("el-input",{model:{value:t.form.password,callback:function(e){t.$set(t.form,"password",e)},expression:"form.password"}})],1),t._v(" "),o("el-form-item",[o("el-button",{attrs:{type:"primary"},on:{click:t.onSubmit}},[t._v("Login")]),t._v(" "),o("el-button",[t._v("Cancel")])],1),t._v(" "),o("div",[t._v(t._s(t.status))])],1)],1)],1)},S=[],y={render:b,staticRenderFns:S},w=y,k=o("VU/8"),I=k(v,w,!1,null,null,null),x=I.exports,R=(o("DtRx"),{data:function(){return{socket:h()({query:{u:localStorage.getItem("userid"),r:localStorage.getItem("current_room")}}),current_room:localStorage.getItem("current_room"),msgs:[],temp_msg:"",dialog_visible:!1,file_list:[],max_file_amount:1,url:"https://chat-room-image.s3.us-west-1.amazonaws.com"}},created:function(){var t=this;this.socket.on("chat",function(e){t.msgs.push(e)}),localStorage.getItem("logs")||localStorage.setItem("logs",{}),localStorage.getItem("logs")[this.current_room]?this.msgs=localStorage.getItem("logs")[this.current_room]:a.default.http.get("v1/logs/"+this.current_room).then(function(e){t.msgs=e.data.logs}).catch(function(t){console.log(t)})},methods:{isImage:function(t){return-1!==t.indexOf(this.url)},send:function(t){this.socket.emit("chat",t),this.temp_msg=""},tableRowClassName:function(t){var e=t.row;t.rowIndex;return e.who===localStorage.getItem("userid")?"your-word":""},goRooms:function(){this.socket.close(),this.$router.replace("/rooms")},handleRemove:function(t,e){console.log(t)},handleExceed:function(){this.$message.warning("Only upload file "+this.maxFileAmount+" at a time")},handleSuccess:function(t){this.$message.success("Upload success"),this.socket.emit("chat",t.url)},handleError:function(t,e,o){console.log(t)},handleChange:function(t,e){var o="image/jpeg"===t.raw.type,s=t.size/1024/1024<2;o||this.$message.error("picture must be JPG format!"),s||this.$message.error("picture size can not exceed 2MB!")},beforeUpload:function(t){var e="image/jpeg"===t.type,o=t.size/1024/1024<2;return e||this.$message.error("picture must be JPG format!"),o||this.$message.error("picture size can not exceed 2MB!"),e&&o},upload:function(){this.dialog_visible=!1,this.$refs.upload.submit()}}}),$=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",[o("el-row",[o("el-col",{attrs:{span:22}},[o("h4",{staticStyle:{"text-align":"left"}},[o("i",{staticClass:"el-icon-star-on"}),t._v(" "+t._s(t.current_room)+" "),o("i",{staticClass:"el-icon-star-on"})])]),t._v(" "),o("el-col",{attrs:{span:2}},[o("el-button",{attrs:{type:"success",round:""},on:{click:t.goRooms}},[t._v("Go Back")])],1)],1),t._v(" "),o("el-table",{staticStyle:{width:"100%"},attrs:{data:t.msgs,"row-class-name":t.tableRowClassName}},[o("el-table-column",{attrs:{prop:"u",width:"180"}}),t._v(" "),o("el-table-column",{scopedSlots:t._u([{key:"default",fn:function(e){return[t.isImage(e.row.m)?o("img",{staticClass:"chat-img",attrs:{src:e.row.m}}):o("div",[t._v(t._s(e.row.m))])]}}])})],1),t._v(" "),o("el-row",{attrs:{gutter:20}},[o("form",{ref:"form",attrs:{id:"fix-form"},on:{submit:function(e){e.preventDefault(),t.send(t.temp_msg)}}},[o("el-col",{attrs:{span:20}},[o("el-input",{model:{value:t.temp_msg,callback:function(e){t.temp_msg=e},expression:"temp_msg"}})],1),t._v(" "),o("el-col",{attrs:{span:2}},[o("el-button",{attrs:{round:""},on:{click:function(e){t.send(t.temp_msg)}}},[t._v("Send")])],1),t._v(" "),o("el-col",{attrs:{span:2}},[o("el-button",{attrs:{round:""},on:{click:function(e){t.dialog_visible=!0}}},[o("i",{staticClass:"el-icon-picture-outline"})])],1)],1)]),t._v(" "),o("el-dialog",{attrs:{visible:t.dialog_visible,width:"35%"},on:{"update:visible":function(e){t.dialog_visible=e}}},[o("el-upload",{ref:"upload",staticClass:"upload-demo",attrs:{drag:"",action:"/v1/test",accept:"image/jpeg","list-type":"picture",name:"uploadimg",limit:t.max_file_amount,"file-list":t.file_list,"on-remove":t.handleRemove,"on-exceed":t.handleExceed,"on-success":t.handleSuccess,"on-error":t.handleError,"on-change":t.handleChange,"before-upload":t.beforeUpload,"auto-upload":!1,"with-credentials":!0}},[o("i",{staticClass:"el-icon-upload"}),t._v(" "),o("div",{staticClass:"el-upload__text"},[t._v("Drop image here or "),o("em",[t._v("click to upload")])]),t._v(" "),o("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[t._v("jpg files with a size less than 2MB")])]),t._v(" "),o("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[o("el-button",{on:{click:function(e){t.dialog_visible=!1}}},[t._v("Cancel")]),t._v(" "),o("el-button",{attrs:{type:"primary"},on:{click:t.upload}},[t._v("Confirm")])],1)],1)],1)},j=[],C={render:$,staticRenderFns:j},E=C,D=o("VU/8"),O=s,U=D(R,E,!1,O,"data-v-47763d1c",null),z=U.exports,B={data:function(){return{my_rooms:[],all_rooms:[],status:"",socket:h()()}},mounted:function(){var t=this;localStorage.removeItem("current_room"),a.default.http.get("/v1/rooms/"+localStorage.getItem("userid")).then(function(e){e.data&&(t.my_rooms=e.data.join_rooms,t.all_rooms=e.data.allrooms.map(function(t){return t._id}),localStorage.setItem("joined_rooms",t.my_rooms))}).catch(function(e){localStorage.getItem("joined_rooms")&&(t.my_rooms=localStorage.getItem("joined_rooms"),console.log("load local"))})},methods:{enter:function(t){localStorage.setItem("current_room",t),this.socket.close(),this.$router.replace("/chat")},leave:function(t){var e=this;a.default.http.post("/v1/room",{action:"leave",roomid:t,userid:localStorage.getItem("userid")}).then(function(o){if(o.body.roomid){var s=e.my_rooms.indexOf(t);e.my_rooms.splice(s,1),localStorage.setItem("joined_rooms",e.my_rooms),localStorage.getItem("current_room")===t&&localStorage.removeItem("current_room"),"room deleted"===o.body.roomid&&(s=e.all_rooms.indexOf(t),e.all_rooms.splice(s,1)),e.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"leave room",message:t})}else e.status="leave room failed",e.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"leave room",message:"failed"})})},join:function(t){var e=this;a.default.http.post("/v1/room",{action:"enter",roomid:t,userid:localStorage.getItem("userid")}).then(function(o){o.body.roomid?(e.my_rooms.push(o.body.roomid),localStorage.setItem("joined_rooms",e.my_rooms),e.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"join room",message:t})):(e.status="join room failed",e.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"join room",message:"failed"}))})},onSubmit:function(){var t=this;a.default.http.post("/v1/room",{action:"enter",roomid:null,userid:localStorage.getItem("userid")}).then(function(e){e.body.roomid?(t.my_rooms.push(e.body.roomid),t.all_rooms.push(e.body.roomid),localStorage.setItem("joined_rooms",t.my_rooms),t.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"create a new room",message:e.body.roomid})):(t.status="enter new room failed",t.socket.emit("stats",{userid:localStorage.getItem("userid"),action:"enter new room",message:"failed"}))})}}},F=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("el-container",[o("el-container",[o("el-aside",{attrs:{width:"200px"}},[o("el-form",{ref:"form"},[t._v("\n        Create a new room\n        "),o("el-form-item",[o("el-button",{attrs:{type:"primary"},on:{click:t.onSubmit}},[t._v("Create")])],1)],1)],1),t._v(" "),o("el-main",t._l(t.all_rooms,function(e){return o("el-col",{key:e},[o("el-button",{attrs:{type:"primary",disabled:-1===t.my_rooms.indexOf(e)},on:{click:function(o){t.enter(e)}}},[t._v(t._s(e))]),t._v(" "),-1!==t.my_rooms.indexOf(e)?o("el-button",{attrs:{type:"danger",round:""},on:{click:function(o){t.leave(e)}}},[t._v("Leave Room")]):o("el-button",{attrs:{type:"success",round:""},on:{click:function(o){t.join(e)}}},[t._v("Join Room")])],1)}))],1)],1)},L=[],V={render:F,staticRenderFns:L},q=V,G=o("VU/8"),J=r,M=G(B,q,!1,J,null,null),N=M.exports,P={data:function(){return{rooms_amount:0,user_amount:0,socket:h()(),logs:[]}},beforeRouteEnter:function(t,e,o){a.default.http.get("/v1/stats").then(function(t){if(!(t.body.logs&&t.body.room&&t.body.user))throw new Error("missing info in log object");o(function(e){return e.setData(t.body)})}).catch(function(t){console.log(t),console.log("fetch stats failed!"),o("/rooms")})},created:function(){var t=this;this.socket.on("stats",function(e){var o=new Date(e.t);e.t=o.toLocaleString(),t.logs.push(e)})},methods:{goRooms:function(){this.socket.close(),this.$router.replace("/rooms")},setData:function(t){t.logs.forEach(function(t){var e=new Date(t.t);return t.t=e.toLocaleString(),t}),this.logs=t.logs,this.rooms_amount=t.room,this.user_amount=t.user}}},A=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("el-container",[o("el-aside",{attrs:{width:"200px"}},[o("el-button",{attrs:{type:"success",round:""},on:{click:t.goRooms}},[t._v("Go Back")]),t._v(" "),o("div",[t._v("Existed room: "+t._s(t.rooms_amount))]),t._v(" "),o("div",[t._v("Existed user: "+t._s(t.user_amount))])],1),t._v(" "),o("el-main",[o("el-table",{staticStyle:{width:"100%"},attrs:{data:t.logs}},[o("el-table-column",{attrs:{prop:"t"}}),t._v(" "),o("el-table-column",{attrs:{prop:"u"}}),t._v(" "),o("el-table-column",{attrs:{prop:"act"}}),t._v(" "),o("el-table-column",{attrs:{prop:"m"}})],1)],1)],1)},H=[],K={render:A,staticRenderFns:H},T=K,W=o("VU/8"),Y=W(P,T,!1,null,null,null),Z=Y.exports;a.default.use(g.a),a.default.use(p.a);var Q=new p.a({mode:"history",routes:[{path:"/",name:"HelloWorld",component:x,beforeEnter:function(t,e,o){localStorage.getItem("userid")?o("/rooms"):o()}},{path:"/chat",name:"ChatPanel",component:z,beforeEnter:function(t,e,o){localStorage.getItem("userid")||o("/"),localStorage.getItem("current_room")?o():o("/rooms")}},{path:"/rooms",name:"Rooms",component:N,beforeEnter:function(t,e,o){localStorage.getItem("userid")?o():o("/")}},{path:"/stats",name:"Stats",component:Z}]}),X=o("zL8q"),tt=o.n(X),et=(o("tvR6"),o("wUZ8")),ot=o.n(et);a.default.config.productionTip=!1,a.default.use(tt.a,{locale:ot.a}),new a.default({el:"#app",router:Q,template:"<App/>",components:{App:f}})},iBKY:function(t,e){},tvR6:function(t,e){}},["NHnr"]);
//# sourceMappingURL=app.9b947b9e5ed6e8d2bc01.js.map